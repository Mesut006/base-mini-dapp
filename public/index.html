<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mesut ‚Äì HelloBase Mini App</title>

  <meta name="base:app_id" content="69414c52d19763ca26ddc34d" />

  <!-- Farcaster Mini App -->
  <meta
    name="fc:miniapp"
    content='{"version":"1","imageUrl":"https://base-mini-dapp.vercel.app/og.png","button":{"title":"Open Mini App","action":{"type":"launch_miniapp","url":"https://base-mini-dapp.vercel.app/"}}}'
  />

  <!-- ethers (encode i√ßin) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --card:#020617;
      --border:#1e293b;
      --accent:#3b82f6;
      --text:#e5e7eb;
      --muted:#9ca3af;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:16px;
      background:radial-gradient(circle at top,#1d4ed8 0,#020617 45%,#000 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      display:flex;
      justify-content:center;
      min-height:100dvh;
    }
    .shell{
      max-width:960px;
      width:100%;
      display:grid;
      grid-template-columns:3fr 2fr;
      gap:20px;
    }
    @media(max-width:768px){.shell{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:20px;
      padding:22px;
      box-shadow:0 22px 45px rgba(0,0,0,.75);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top left,rgba(59,130,246,.18),transparent 55%);
      pointer-events:none;
    }
    .card-inner{position:relative;z-index:1}

    .header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      margin-bottom:16px;
    }
    .logo{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(51,65,85,.8);
      font-size:11px;
      color:var(--muted);
    }
    .dot{
      width:18px;height:18px;border-radius:999px;
      background:#0ea5e9;
      box-shadow:0 0 0 3px rgba(14,165,233,.25);
    }
    h1{margin:6px 0 0;font-size:20px}
    .sub{font-size:12px;color:var(--muted);margin-top:4px}

    button{
      background:var(--accent);
      border:none;
      border-radius:999px;
      padding:8px 16px;
      color:#fff;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    button:disabled{background:#4b5563;cursor:not-allowed}

    .section{margin-top:18px}
    .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
    .box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(15,23,42,.95);
      font-size:12px;
      word-break:break-all;
    }
    input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
    }
    .status{font-size:11px;color:var(--muted);margin-top:6px;min-height:16px}

    .warn{
      position:fixed;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      max-width:960px;
      width:calc(100% - 32px);
      background:rgba(127,29,29,.95);
      border:1px solid rgba(248,113,113,.6);
      color:#fecaca;
      padding:8px 12px;
      border-radius:14px;
      font-size:12px;
      display:none;
      z-index:50;
    }
  </style>
</head>

<body>

<div class="warn" id="networkWarn">
  ‚ö†Ô∏è This dApp works on <strong>Base Mainnet (8453)</strong>
</div>

<div class="shell">

  <!-- MAIN -->
  <div class="card">
    <div class="card-inner">

      <div class="header">
        <div>
          <div class="logo"><div class="dot"></div>Base ‚Ä¢ Mini App</div>
          <h1>HelloBase Dashboard</h1>
          <div class="sub">Mesut‚Äôun Base √ºzerindeki on-chain mesaj kontratƒ±</div>
        </div>
        <div>
          <button id="connectBtn">C√ºzdanƒ± Baƒüla</button>
          <div class="status" id="walletStatus"></div>
        </div>
      </div>

      <div class="section">
        <div class="label">Aktif Mesaj</div>
        <div class="box" id="currentMessage">-</div>
      </div>

      <div class="section">
        <div class="label">Yeni Mesaj</div>
        <input id="newMessage" placeholder="Merhaba Base üëã" />
        <button id="sendBtn" disabled style="margin-top:10px">Mesajƒ± G√ºncelle</button>
        <div class="status" id="txStatus"></div>
      </div>

    </div>
  </div>

  <!-- SIDE -->
  <div class="card">
    <div class="card-inner">
      <div class="label">Bu mini app ne yapƒ±yor?</div>
      <div class="box">
        C√ºzdanƒ±nƒ± Farcaster √ºzerinden baƒülar, Base Mainnet‚Äôteki kontrattaki
        mesajƒ± okur ve <strong>wallet_sendCalls</strong> ile on-chain g√ºnceller.
      </div>
    </div>
  </div>

</div>

<script type="module">
  import sdk from "https://esm.sh/@farcaster/miniapp-sdk";
  const ethers = window.ethers;

  const CONTRACT = "0xD6e402b477B05f8105be4fAaC4a43E0355aCc8F8";
  const CHAIN_DEC = 8453;
  const CHAIN_HEX = "0x2105";

  const ABI = [
    {"inputs":[],"name":"message","outputs":[{"type":"string"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"name":"newMessage","type":"string"}],"name":"setMessage","outputs":[],"stateMutability":"nonpayable","type":"function"}
  ];

  const connectBtn = document.getElementById("connectBtn");
  const sendBtn = document.getElementById("sendBtn");
  const walletStatus = document.getElementById("walletStatus");
  const txStatus = document.getElementById("txStatus");
  const currentMessage = document.getElementById("currentMessage");
  const newMessage = document.getElementById("newMessage");
  const networkWarn = document.getElementById("networkWarn");

  let eip1193, provider, address, chainId;

  const short = a => a.slice(0,6)+"‚Ä¶"+a.slice(-4);

  async function connect(){
    walletStatus.textContent="Baƒülanƒ±yor‚Ä¶";
    eip1193 = await sdk.wallet.getEthereumProvider();
    provider = new ethers.providers.Web3Provider(eip1193,"any");
    const acc = await provider.send("eth_requestAccounts",[]);
    address = acc[0];
    chainId = (await provider.getNetwork()).chainId;

    if(chainId!==CHAIN_DEC){
      networkWarn.style.display="block";
      walletStatus.textContent="Base Mainnet se√ßilmedi";
      return;
    }
    walletStatus.textContent=`Baƒülƒ±: ${short(address)}`;
    sendBtn.disabled=false;
    readMessage();
  }

  async function readMessage(){
    const c = new ethers.Contract(CONTRACT,ABI,provider);
    currentMessage.textContent = await c.message();
  }

  async function sendMessage(){
    const text=newMessage.value.trim();
    if(!text) return;
    txStatus.textContent="C√ºzdanda onay bekleniyor‚Ä¶";

    const iface=new ethers.utils.Interface(ABI);
    const data=iface.encodeFunctionData("setMessage",[text]);

    await eip1193.request({
      method:"wallet_sendCalls",
      params:[{
        version:"2.0.0",
        chainId:CHAIN_HEX,
        from:address,
        calls:[{to:CONTRACT,data,value:"0x0"}]
      }]
    });

    txStatus.textContent="ƒ∞≈ülem g√∂nderildi ‚úÖ";
    newMessage.value="";
    readMessage();
  }

  connectBtn.onclick=connect;
  sendBtn.onclick=sendMessage;
  try{await sdk.actions.ready()}catch{}
</script>

</body>
</html>
