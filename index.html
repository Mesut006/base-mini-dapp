  <script>
    const ethers = window.ethers;

    // Bu dApp'in hedef ağı: Base Mainnet
    const EXPECTED_CHAIN_ID = 8453;

    // Senin kontrat adresin
    const CONTRACT_ADDRESS = "0xD6e402b477B05f8105be4fAaC4a43E0355aCc8F8";

    // HelloBase ABI
    const CONTRACT_ABI = [
      {
        "inputs": [],
        "name": "message",
        "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "string", "name": "newMessage", "type": "string" }],
        "name": "setMessage",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    let provider;
    let signer;
    let contract;
    let lastNetworkChainId = null;
    let txHistory = [];
    let isConnecting = false;   // tekrar tekrar connect çağrılmasını engelle

    const connectButton = document.getElementById("connectButton");
    const walletInfo = document.getElementById("walletInfo");
    const currentMessageEl = document.getElementById("currentMessage");
    const currentMessageBox = document.getElementById("currentMessageBox");
    const refreshMessageButton = document.getElementById("refreshMessageButton");
    const newMessageInput = document.getElementById("newMessageInput");
    const setMessageButton = document.getElementById("setMessageButton");
    const txStatus = document.getElementById("txStatus");

    const walletChipContainer = document.getElementById("walletChipContainer");
    const walletAvatar = document.getElementById("walletAvatar");
    const walletShortLabel = document.getElementById("walletShortLabel");

    const txList = document.getElementById("txList");

    const networkWarning = document.getElementById("networkWarning");
    const networkWarningText = document.getElementById("networkWarningText");

    function setWalletVisual(address) {
      if (!address) {
        walletChipContainer.style.display = "none";
        return;
      }

      const short = address.slice(0, 6) + "…" + address.slice(-4);
      const initials = address.slice(2, 4).toUpperCase();

      const segment = address.slice(2, 6);
      let hue = parseInt(segment, 16);
      if (Number.isNaN(hue)) hue = 210;
      hue = hue % 360;

      walletAvatar.textContent = initials;
      walletAvatar.style.background = `linear-gradient(135deg, hsl(${hue},80%,60%), hsl(${(hue + 40) % 360},80%,50%))`;
      walletShortLabel.textContent = short;
      walletChipContainer.style.display = "block";
    }

    function formatTimeAgo(ts) {
      const diffMs = Date.now() - ts;
      const sec = Math.floor(diffMs / 1000);
      if (sec < 60) return "az önce";
      const min = Math.floor(sec / 60);
      if (min < 60) return `${min} dk önce`;
      const hour = Math.floor(min / 60);
      if (hour < 24) return `${hour} saat önce`;
      const day = Math.floor(hour / 24);
      return `${day} gün önce`;
    }

    function saveTxHistory() {
      try {
        localStorage.setItem("helloBaseTxHistory", JSON.stringify(txHistory));
      } catch (e) {
        console.warn("Tx history kaydedilemedi:", e);
      }
    }

    function loadTxHistory() {
      try {
        const raw = localStorage.getItem("helloBaseTxHistory");
        if (!raw) {
          txHistory = [];
        } else {
          txHistory = JSON.parse(raw) || [];
        }
      } catch {
        txHistory = [];
      }
      renderTxHistory();
    }

    function renderTxHistory() {
      if (!txList) return;
      if (!txHistory.length) {
        txList.innerHTML = '<div class="tx-empty">Bu dApp üzerinden henüz işlem yapmadın.</div>';
        return;
      }

      txList.innerHTML = txHistory
        .map((item) => {
          const shortHash = item.hash.slice(0, 6) + "…" + item.hash.slice(-4);
          const timeAgo = formatTimeAgo(item.timestamp);
          const chain = item.chainId ? `chainId: ${item.chainId}` : "";
          const explorer = item.explorerUrl
            ? `<a class="tx-link" href="${item.explorerUrl}" target="_blank">BaseScan</a>`
            : "";

          return `
            <div class="tx-item">
              <div class="tx-row">
                <span class="tx-hash">${shortHash}</span>
                <span class="tx-meta">${timeAgo}</span>
              </div>
              <div class="tx-meta">
                ${chain} ${explorer ? "• " + explorer : ""}
              </div>
            </div>
          `;
        })
        .join("");
    }

    function updateNetworkWarning(chainId) {
      if (!chainId) {
        networkWarning.classList.add("hidden");
        return;
      }

      if (chainId !== EXPECTED_CHAIN_ID) {
        networkWarning.classList.remove("hidden");
        networkWarningText.textContent =
          `Bu dApp Base Mainnet (chainId 8453) için tasarlanmıştır. ` +
          `Şu an bağlandığın ağın chainId değeri: ${chainId}. ` +
          `MetaMask’ten ağı Base Mainnet'e çevirirsen dApp tam fonksiyonel çalışır.`;
      } else {
        networkWarning.classList.add("hidden");
      }
    }

    async function connectWallet() {
      if (isConnecting) return;          // üst üste tıklamayı engelle
      if (!window.ethereum) {
        alert("MetaMask bulunamadı. Lütfen Chrome eklentisinin kurulu olduğundan emin ol.");
        return;
      }

      try {
        isConnecting = true;
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts"
        });

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        const network = await provider.getNetwork();
        lastNetworkChainId = network.chainId;

        updateNetworkWarning(network.chainId);

        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        walletInfo.textContent = `Ağ chainId: ${network.chainId} | Cüzdan: ${accounts[0]}`;
        connectButton.querySelector(".btn-label").textContent = "Bağlı";
        setMessageButton.disabled = false;

        setWalletVisual(accounts[0]);
        await readMessage();
      } catch (e) {
        console.error(e);
        alert("Cüzdan bağlanırken hata oluştu: " + (e.message || e));
      } finally {
        isConnecting = false;
      }
    }

    async function readMessage() {
      if (!contract) {
        currentMessageEl.textContent = "Kontrat bağlı değil.";
        return;
      }
      try {
        if (currentMessageBox) currentMessageBox.classList.add("shimmer");
        currentMessageEl.textContent = "Yükleniyor...";
        const msg = await contract.message();
        currentMessageEl.textContent = msg || "(Boş)";
      } catch (e) {
        console.error(e);
        currentMessageEl.textContent = "Mesaj okunurken hata.";
      } finally {
        if (currentMessageBox) currentMessageBox.classList.remove("shimmer");
      }
    }

    async function setMessage() {
      if (!contract) {
        alert("Önce cüzdanı bağlamalısın.");
        return;
      }
      const text = newMessageInput.value.trim();
      if (!text) {
        alert("Lütfen bir mesaj yaz.");
        return;
      }

      try {
        txStatus.textContent = "İşlem gönderiliyor...";
        setMessageButton.disabled = true;
        setMessageButton.classList.add("loading");

        const tx = await contract.setMessage(text);
        txStatus.textContent = "Onay bekleniyor...";

        await tx.wait();

        txStatus.textContent = "İşlem onaylandı ✅";
        await readMessage();

        const explorerUrl =
          lastNetworkChainId === 8453
            ? `https://basescan.org/tx/${tx.hash}`
            : lastNetworkChainId === 84532
            ? `https://sepolia.basescan.org/tx/${tx.hash}`
            : "";

        txHistory.unshift({
          hash: tx.hash,
          timestamp: Date.now(),
          chainId: lastNetworkChainId,
          explorerUrl
        });

        txHistory = txHistory.slice(0, 5);
        saveTxHistory();
        renderTxHistory();

        setTimeout(() => (txStatus.textContent = ""), 4000);
      } catch (e) {
        console.error(e);
        txStatus.textContent = "İşlem hatası: " + (e.message || e);
      } finally {
        setMessageButton.disabled = false;
        setMessageButton.classList.remove("loading");
      }
    }

    connectButton.addEventListener("click", connectWallet);
    refreshMessageButton.addEventListener("click", readMessage);
    setMessageButton.addEventListener("click", setMessage);

    // Sayfa ilk açıldığında local tx geçmişini yükle
    loadTxHistory();
  </script>
