<!DOCTYPE html>
<script type="module">
  import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk@0.2.1";
  window.__fcSdk = sdk;
  await sdk.actions.ready();
</script>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mesut - HelloBase Mini dApp</title>

  <meta name="base:app_id" content="69414c52d19763ca26ddc34d" />

  <!-- Farcaster Mini App Embed -->
  <meta
    name="fc:miniapp"
    content='{"version":"1","imageUrl":"https://base-mini-dapp.vercel.app/og.png","button":{"title":"Open Mini App","action":{"type":"launch_miniapp","name":"HelloBase Dashboard","url":"https://base-mini-dapp.vercel.app/","splashImageUrl":"https://base-mini-dapp.vercel.app/icon.png","splashBackgroundColor":"#020617"}}}'
  />
  <!-- Backward compatibility -->
  <meta
    name="fc:frame"
    content='{"version":"1","imageUrl":"https://base-mini-dapp.vercel.app/og.png","button":{"title":"Open Mini App","action":{"type":"launch_frame","name":"HelloBase Dashboard","url":"https://base-mini-dapp.vercel.app/","splashImageUrl":"https://base-mini-dapp.vercel.app/icon.png","splashBackgroundColor":"#020617"}}}'
  />

  <!-- Ethers.js (v5 UMD) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

 <script type="module">
  import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk@0.2.1";

 <script type="module">
  import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk@0.2.1";

  // ‚úÖ Body tarafƒ±nda da kullanabilmek i√ßin global'e koy
  window.__fcSdk = sdk;

  // Splash'ƒ± kapatmak i√ßin zorunlu
  await sdk.actions.ready();
</script>
   <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --border: #1e293b;
      --accent: #3b82f6;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --text-muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d4ed8 0, #020617 40%, #000 100%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100dvh;
      margin: 0;
      padding: 16px;
    }
    .shell {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 20px;
    }
    @media (max-width: 768px) { .shell { grid-template-columns: 1fr; } }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 22px;
      box-shadow: 0 22px 45px rgba(0,0,0,0.75), 0 0 0 1px rgba(15,23,42,0.9);
      position: relative;
      overflow: hidden;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.18) 0, transparent 55%);
      opacity:.6; pointer-events:none;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 26px 55px rgba(15, 23, 42, 0.95), 0 0 0 1px rgba(37, 99, 235, 0.3);
      border-color: rgba(59,130,246,0.7);
    }
    .card-inner { position: relative; z-index: 1; }

    .header-row{
      display:flex; justify-content:space-between; gap:12px;
      align-items:flex-start; margin-bottom:16px;
    }
    .logo-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius:999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.8);
      font-size:11px; color: var(--text-sub);
    }
    .logo-circle{
      width:18px; height:18px; border-radius:999px;
      background:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,0.25);
    }
    h1{ font-size:20px; margin:0; color:#e0f2fe; letter-spacing:0.02em; }
    .subtitle{ font-size:12px; color: var(--text-sub); margin-top:4px; }
    .badge-row{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .badge{
      font-size:10px; border-radius:999px; padding:3px 9px;
      border: 1px solid rgba(51,65,85,0.9);
      color: var(--text-sub);
      background: rgba(15,23,42,0.9);
    }

    button{
      background: var(--accent);
      border:none; border-radius:999px;
      color:white; padding:8px 16px;
      cursor:pointer; font-size:13px; font-weight:500;
      display:inline-flex; align-items:center; gap:6px;
      white-space:nowrap; transition:all .15s ease;
      position:relative; overflow:hidden;
    }
    button:hover{ background:#1d4ed8; transform: translateY(-1px); box-shadow: 0 10px 30px rgba(37,99,235,0.35); }
    button:disabled{ background:#4b5563; cursor:not-allowed; box-shadow:none; transform:none; }
    .btn-secondary{
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(51,65,85,0.9);
      color: var(--text-sub); box-shadow:none;
    }
    .btn-secondary:hover{
      background: rgba(30,64,175,0.6);
      border-color:#3b82f6; color:#e5e7eb;
    }
    .btn-label{ display:inline-flex; align-items:center; gap:6px; }
    .btn-spinner{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(226,232,240,0.7);
      border-top-color: transparent;
      display:none; animation: spin .7s linear infinite;
    }
    button.loading .btn-spinner{ display:inline-block; }
    button.loading .btn-label{ opacity:.85; }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .section{ margin-top:18px; }
    .label-row{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:6px; gap:10px;
    }
    .label{
      font-size:11px; color: var(--text-sub);
      text-transform: uppercase; letter-spacing:0.08em;
    }
    .pill{ font-size:10px; border-radius:999px; padding:3px 7px;
      border: 1px solid rgba(55,65,81,0.9); color: var(--text-sub); }
    .value-box{
      border-radius:14px; border:1px solid var(--border);
      padding:10px 12px; background: rgba(15,23,42,0.96);
      font-size:12px; word-break:break-all; min-height:38px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      transition: border-color .15s ease, background .15s ease;
    }
    .value-main{ font-size:12px; color: var(--text-main); opacity:.9; }

    input{
      width:100%; padding:9px 11px;
      border-radius:10px; border:1px solid var(--border);
      background: rgba(15,23,42,0.96);
      color: var(--text-main);
      font-size:13px; outline:none;
      transition: all .12s ease;
    }
    input::placeholder{ color:#6b7280; }
    input:focus{ border-color: var(--accent); box-shadow: 0 0 0 1px rgba(59,130,246,0.7); }

    .status{ font-size:11px; color: var(--text-sub); margin-top:4px; min-height:16px; white-space: pre-line; }
    .hint{ font-size:11px; color: var(--text-muted); margin-top:10px; }
    .tag{
      display:inline-flex; font-size:10px; border-radius:999px;
      border: 1px solid rgba(148,163,184,0.8);
      padding:2px 9px; color: var(--text-sub); margin-right:6px;
    }
    .side-card-title{ font-size:13px; font-weight:500; margin-bottom:8px; }
    .timeline{ border-left:1px solid rgba(51,65,85,0.9); margin-left:5px; padding-left:14px; margin-top:6px; }
    .timeline-item{ margin-bottom:12px; position:relative; }
    .timeline-item::before{
      content:""; position:absolute; left:-15px; top:4px;
      width:8px; height:8px; border-radius:999px;
      background:#3b82f6; box-shadow: 0 0 0 3px rgba(37,99,235,0.3);
    }
    .timeline-title{ font-size:12px; color: var(--text-main); }
    .timeline-sub{ font-size:11px; color: var(--text-sub); }

    .wallet-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(51,65,85,0.9);
      font-size:11px; color: var(--text-sub);
      margin-top:8px;
    }
    .wallet-avatar{
      width:22px; height:22px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:600; color:#0b1120;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.9);
    }
    .wallet-label{ font-size:11px; color: var(--text-main); }

    .tx-list{
      margin-top:6px; border-radius:12px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.96);
      padding:8px 10px; max-height:180px; overflow-y:auto;
    }
    .tx-empty{ font-size:11px; color: var(--text-muted); }
    .tx-item{
      font-size:11px; color: var(--text-sub);
      padding:5px 4px; border-radius:8px;
      display:flex; flex-direction:column; gap:2px;
    }
    .tx-item + .tx-item{ border-top:1px solid rgba(30,41,59,0.9); margin-top:4px; }
    .tx-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .tx-hash{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#e5e7eb; }
    .tx-meta{ font-size:10px; color: var(--text-muted); }

    .shimmer{
      position:relative; overflow:hidden;
      background: linear-gradient(90deg, rgba(15,23,42,0.96) 0%, rgba(30,64,175,0.7) 50%, rgba(15,23,42,0.96) 100%);
      background-size:200% 100%;
      animation: shimmer-move 1.2s ease-in-out infinite;
    }
    @keyframes shimmer-move{ 0%{ background-position:-150% 0;} 100%{ background-position:150% 0;} }

    .network-warning{
      position:fixed; top:12px; left:50%;
      transform: translateX(-50%);
      max-width:960px;
      width: calc(100% - 32px);
      border-radius:14px;
      border:1px solid rgba(248,113,113,0.6);
      background: rgba(127,29,29,0.95);
      color:#fee2e2;
      padding:8px 12px;
      font-size:12px;
      display:flex; gap:8px; align-items:flex-start;
      box-shadow: 0 18px 40px rgba(127,29,29,0.7);
      z-index: 50;
    }
    .network-warning-icon{ font-size:16px; line-height:1.2; }
    .network-warning-text strong{ color:#fecaca; }
    .hidden{ display:none; }
  </style>
</head>

<body>
  <div id="networkWarning" class="network-warning hidden">
    <div class="network-warning-icon">‚ö†Ô∏è</div>
    <div class="network-warning-text" id="networkWarningText">
      This dApp is built for <strong>Base Mainnet (chainId 8453)</strong>. Please select the correct network in your wallet.
    </div>
  </div>

  <div class="shell">
    <div class="card">
      <div class="card-inner">
        <div class="header-row">
          <div>
            <div class="logo-pill">
              <div class="logo-circle"></div>
              <span>Base ‚Ä¢ Onchain Mini dApp</span>
            </div>
            <h1>HelloBase Dashboard</h1>
            <div class="subtitle">Mesut‚Äôun Base √ºzerindeki doƒürulanmƒ±≈ü kontratƒ±yla c√ºzdanƒ±ndan direkt etkile≈üime ge√ß.</div>
            <div class="badge-row">
              <div class="badge">Deployed ‚Ä¢ 0xD6e4‚Ä¶c8F8</div>
              <div class="badge">Verified on BaseScan</div>
              <div class="badge">Built by Mesut</div>
            </div>
          </div>

          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
           <button id="connectButton" onclick="window.__hbClickTest?.()">
  <span class="btn-label">C√ºzdanƒ± Baƒüla</span>
  <span class="btn-spinner" aria-hidden="true"></span>
</button>

            <div id="walletStatus" style="font-family: ui-monospace, monospace; font-size:11px; color:#9ca3af; min-height:14px;"></div>
          </div>
        </div>

        <div class="section">
          <div class="label-row">
            <span class="label">Baƒülantƒ± durumu</span>
            <span class="pill">EVM Wallet ‚Ä¢ Base</span>
          </div>
          <div class="value-box" id="walletInfo">
            <div class="value-main" id="walletInfoText">Baƒülƒ± deƒüil</div>
          </div>

          <div id="walletChipContainer" style="margin-top: 6px; display:none;">
            <div class="wallet-chip">
              <div id="walletAvatar" class="wallet-avatar">--</div>
              <div class="wallet-label" id="walletShortLabel">C√ºzdan baƒülƒ± deƒüil</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="label-row">
            <span class="label">Kontrat adresi</span>
            <span class="pill">HelloBase.sol</span>
          </div>
          <div class="value-box">
            <div class="value-main">0xD6e402b477B05f8105be4fAaC4a43E0355aCc8F8</div>
          </div>
        </div>

        <div class="section">
          <div class="label-row">
            <span class="label">Aktif mesaj (message)</span>
            <button class="btn-secondary" id="refreshMessageButton">Yenile</button>
          </div>
          <div class="value-box" id="currentMessageBox">
            <div class="value-main" id="currentMessage">-</div>
          </div>
        </div>

        <div class="section">
          <div class="label-row">
            <span class="label">Yeni mesaj yaz</span>
          </div>
          <input id="newMessageInput" placeholder="√ñrn: Merhaba Base, Mesut buradaydƒ± ‚ú®" />
          <div class="label-row" style="margin-top: 10px;">
            <div class="status" id="txStatus"></div>
            <button id="setMessageButton" disabled>
              <span class="btn-label">Mesajƒ± G√ºncelle</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
          </div>
        </div>

        <div class="hint">
          <span class="tag">ƒ∞pucu</span>
          Bu dApp Base Mainnet (8453) i√ßin. Yanlƒ±≈ü aƒüdaysan √ºstte uyarƒ± g√∂r√ºrs√ºn.
        </div>

        <div class="section">
          <div class="label-row">
            <span class="label">Bu dApp ile i≈ülem ge√ßmi≈üin</span>
            <span class="pill">Son 5 i≈ülem</span>
          </div>
          <div class="tx-list" id="txList">
            <div class="tx-empty">Bu dApp √ºzerinden hen√ºz i≈ülem yapmadƒ±n.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-inner">
        <div class="side-card-title">Bu mini dApp ne yapƒ±yor?</div>
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-title">1. C√ºzdanƒ±nƒ± baƒülƒ±yorsun</div>
            <div class="timeline-sub">Web‚Äôde injected wallet (MetaMask/Rabby) veya Farcaster SDK provider.</div>
          </div>
          <div class="timeline-item">
            <div class="timeline-title">2. Kontrattaki mesajƒ± okuyor</div>
            <div class="timeline-sub">HelloBase kontratƒ±ndaki <code>message()</code> fonksiyonunu √ßaƒüƒ±rƒ±r.</div>
          </div>
          <div class="timeline-item">
            <div class="timeline-title">3. On-chain mesaj g√ºncelleme</div>
            <div class="timeline-sub">√ñnce <code>wallet_sendCalls</code> dener, yoksa normal tx ile g√∂nderir.</div>
          </div>
        </div>

        <div class="hint" style="margin-top:14px;">
          ƒ∞leride buraya token, NFT, leaderboard gibi √∂zellikler ekleyebilirsin. üíô
        </div>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      // SDK yakala (UMD)
      const sdkRoot = window.FarcasterMiniAppSDK || null;
      const sdk = (sdkRoot && (sdkRoot.sdk || sdkRoot)) || null;

      // Splash‚Äôte takƒ±lma √∂nlemi
      let readyCalled = false;
      async function safeReady() {
        if (readyCalled) return;
        readyCalled = true;
        try { await sdk?.actions?.ready?.(); } catch (e) {}
      }
      setTimeout(safeReady, 2500);
      window.addEventListener("error", (e) => {
        const el = document.getElementById("walletStatus");
        if (el) el.textContent = "JS error: " + (e?.message || "unknown");
        safeReady();
      });
      window.addEventListener("unhandledrejection", (e) => {
        const el = document.getElementById("walletStatus");
        if (el) el.textContent = "Promise error: " + (e?.reason?.message || String(e?.reason || "unknown"));
        safeReady();
      });

      // ‚úÖ √∂nce ready dene
      await safeReady();

      const ethers = window.ethers;
      if (!ethers) {
        alert("ethers y√ºklenemedi (CDN engellenmi≈ü olabilir).");
        return;
      }

      const EXPECTED_CHAIN_ID = 8453;
      const EXPECTED_CHAIN_ID_HEX = "0x2105";
      const CONTRACT_ADDRESS = "0xD6e402b477B05f8105be4fAaC4a43E0355aCc8F8";
      const CONTRACT_ABI = [
        { "inputs": [], "name": "message", "outputs": [{ "type": "string" }], "stateMutability": "view", "type": "function" },
        { "inputs": [{ "name": "newMessage", "type": "string" }], "name": "setMessage", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
      ];

      const connectButton = document.getElementById("connectButton");
      const walletStatus = document.getElementById("walletStatus");
      const walletInfoText = document.getElementById("walletInfoText");
      const refreshMessageButton = document.getElementById("refreshMessageButton");
      const currentMessageEl = document.getElementById("currentMessage");
      const currentMessageBox = document.getElementById("currentMessageBox");
      const newMessageInput = document.getElementById("newMessageInput");
      const setMessageButton = document.getElementById("setMessageButton");
      const txStatus = document.getElementById("txStatus");
      const txList = document.getElementById("txList");
      const networkWarning = document.getElementById("networkWarning");
      const networkWarningText = document.getElementById("networkWarningText");
      const walletChipContainer = document.getElementById("walletChipContainer");
      const walletAvatar = document.getElementById("walletAvatar");
      const walletShortLabel = document.getElementById("walletShortLabel");

      let eip1193 = null;
      let web3Provider = null;
      let address = null;
      let lastChainId = null;
      let contractRead = null;

      let txHistory = [];
      const TX_KEY = "helloBaseTxHistory";

      function setTopStatus(text) { walletStatus.textContent = text || ""; }
      function shortAddr(addr) { return addr ? `${addr.slice(0, 6)}‚Ä¶${addr.slice(-4)}` : ""; }
      function setBtnLoading(btn, loading) { btn.classList.toggle("loading", !!loading); btn.disabled = !!loading; }

      function setWalletVisual(addr) {
        if (!addr) { walletChipContainer.style.display = "none"; return; }
        const initials = addr.slice(2, 4).toUpperCase();
        const segment = addr.slice(2, 6);
        let hue = parseInt(segment, 16);
        if (Number.isNaN(hue)) hue = 210;
        hue = hue % 360;
        walletAvatar.textContent = initials;
        walletAvatar.style.background = `linear-gradient(135deg, hsl(${hue},80%,60%), hsl(${(hue + 40) % 360},80%,50%))`;
        walletShortLabel.textContent = shortAddr(addr);
        walletChipContainer.style.display = "block";
      }

      function updateNetworkWarning(chainId) {
        if (!chainId) { networkWarning.classList.add("hidden"); return; }
        if (chainId !== EXPECTED_CHAIN_ID) {
          networkWarning.classList.remove("hidden");
          networkWarningText.innerHTML =
            `This dApp is built for <strong>Base Mainnet (chainId 8453)</strong>. ` +
            `Current connected chainId: <strong>${chainId}</strong>.`;
        } else {
          networkWarning.classList.add("hidden");
        }
      }

      aasync function getEip1193Provider() {
  const sdk = window.__fcSdk;

  // Mini App i√ßinde: host wallet provider
  try {
    const isMini = await sdk?.isInMiniApp?.().catch(() => false);
    if (isMini) {
      const p = await sdk.wallet.getEthereumProvider();
      return p || null;
    }
  } catch (e) {
    // yut
  }

  // Normal web
  if (window.ethereum?.request) return window.ethereum;

  return null;
}


      function loadTxHistory() {
        try {
          const raw = localStorage.getItem(TX_KEY);
          txHistory = raw ? (JSON.parse(raw) || []) : [];
        } catch { txHistory = []; }
        renderTxHistory();
      }
      function saveTxHistory() {
        try { localStorage.setItem(TX_KEY, JSON.stringify(txHistory)); } catch {}
      }
      function formatTimeAgo(ts) {
        const diffMs = Date.now() - ts;
        const sec = Math.floor(diffMs / 1000);
        if (sec < 60) return "az √∂nce";
        const min = Math.floor(sec / 60);
        if (min < 60) return `${min} dk √∂nce`;
        const hour = Math.floor(min / 60);
        if (hour < 24) return `${hour} saat √∂nce`;
        const day = Math.floor(hour / 24);
        return `${day} g√ºn √∂nce`;
      }
      function renderTxHistory() {
        if (!txHistory.length) {
          txList.innerHTML = '<div class="tx-empty">Bu dApp √ºzerinden hen√ºz i≈ülem yapmadƒ±n.</div>';
          return;
        }
        txList.innerHTML = txHistory.map((item) => {
          const shortId = `${item.id.slice(0, 6)}‚Ä¶${item.id.slice(-4)}`;
          const timeAgo = formatTimeAgo(item.timestamp);
          return `
            <div class="tx-item">
              <div class="tx-row">
                <span class="tx-hash">${shortId}</span>
                <span class="tx-meta">${timeAgo}</span>
              </div>
              <div class="tx-meta">${item.kind} ‚Ä¢ chainId: ${item.chainId}</div>
            </div>
          `;
        }).join("");
      }

      async function readMessage() {
        if (!contractRead) return;
        try {
          currentMessageBox.classList.add("shimmer");
          currentMessageEl.textContent = "Y√ºkleniyor...";
          const msg = await contractRead.message();
          currentMessageEl.textContent = msg || "(Bo≈ü)";
        } catch (e) {
          console.error(e);
          currentMessageEl.textContent = "Mesaj okunurken hata.";
        } finally {
          currentMessageBox.classList.remove("shimmer");
        }
      }

      async function refreshState() {
        if (!web3Provider) return;

        const accounts = await web3Provider.listAccounts();
        address = accounts?.[0] || null;

        const net = await web3Provider.getNetwork();
        lastChainId = net.chainId;

        updateNetworkWarning(lastChainId);

        if (!address) {
          walletInfoText.textContent = "Baƒülƒ± deƒüil";
          setWalletVisual(null);
          setMessageButton.disabled = true;
          return;
        }

        walletInfoText.textContent = `Aƒü chainId: ${lastChainId} | C√ºzdan: ${shortAddr(address)}`;
        setWalletVisual(address);

        setMessageButton.disabled = (lastChainId !== EXPECTED_CHAIN_ID);

        contractRead = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, web3Provider);
        await readMessage();
      }

     async function connectWallet() {
  setTopStatus("Baƒülanƒ±lƒ±yor...");
  setBtnLoading(connectButton, true);

  try {
    // 1) √ñnce Farcaster Mini App provider
    const sdk = window.__fcSdk;
    let provider = null;

    try {
      const isMini = await sdk?.isInMiniApp?.().catch(() => false);
      if (isMini) provider = await sdk.wallet.getEthereumProvider();
    } catch (e) {}

    // 2) Mini App yoksa web provider
    if (!provider && window.ethereum?.request) provider = window.ethereum;

    // 3) Provider yoksa bitti
    if (!provider || typeof provider.request !== "function") {
      setTopStatus("C√ºzdan bulunamadƒ±. Mini App i√ßinde a√ßtƒ±ƒüƒ±ndan emin ol.");
      return;
    }

    // 4) Hesap iste (asƒ±l baƒülama burasƒ±)
    const accounts = await provider.request({ method: "eth_requestAccounts", params: [] });
    if (!accounts || !accounts.length) {
      setTopStatus("C√ºzdan baƒülanamadƒ± (hesap gelmedi).");
      return;
    }

    // 5) Ethers provider kur
    eip1193 = provider;
    web3Provider = new ethers.providers.Web3Provider(provider, "any");

    connectButton.querySelector(".btn-label").textContent = "Baƒülƒ±";
    setTopStatus("Hazƒ±r ‚úÖ");
    await refreshState();
  } catch (e) {
    console.error(e);
    setTopStatus("Baƒülantƒ± hatasƒ±: " + (e?.message || String(e)));
  } finally {
    setBtnLoading(connectButton, false);
  }
}


      async function setMessage() {
        if (!eip1193 || !address) {
          txStatus.textContent = "√ñnce c√ºzdanƒ± baƒülamalƒ±sƒ±n.";
          return;
        }
        if (lastChainId !== EXPECTED_CHAIN_ID) {
          txStatus.textContent = "√ñnce Base Mainnet (8453) aƒüƒ±na ge√ßmelisin.";
          return;
        }

        const text = newMessageInput.value.trim();
        if (!text) {
          txStatus.textContent = "L√ºtfen bir mesaj yaz.";
          return;
        }

        setBtnLoading(setMessageButton, true);
        txStatus.textContent = "C√ºzdanda onay bekleniyor...";

        try {
          const iface = new ethers.utils.Interface(CONTRACT_ABI);
          const data = iface.encodeFunctionData("setMessage", [text]);

          const okSendCalls = await canSendCalls(eip1193, EXPECTED_CHAIN_ID_HEX);

          if (okSendCalls) {
            const callsId = await eip1193.request({
              method: "wallet_sendCalls",
              params: [{
                version: "2.0.0",
                chainId: EXPECTED_CHAIN_ID_HEX,
                from: address,
                atomicRequired: false,
                calls: [{ to: CONTRACT_ADDRESS, data, value: "0x0" }]
              }]
            });

            const idStr = String(callsId || (crypto?.randomUUID?.() || (Date.now() + "-" + Math.random())));
            txHistory.unshift({ id: idStr, kind: "sendCalls", chainId: lastChainId, timestamp: Date.now() });
          } else {
            const signer = web3Provider.getSigner();
            const tx = await signer.sendTransaction({ to: CONTRACT_ADDRESS, data, value: 0 });
            txHistory.unshift({ id: String(tx.hash), kind: "tx", chainId: lastChainId, timestamp: Date.now() });
          }

          txHistory = txHistory.slice(0, 5);
          saveTxHistory();
          renderTxHistory();

          txStatus.textContent = "ƒ∞≈ülem g√∂nderildi ‚úÖ";
          newMessageInput.value = "";
          await readMessage();
          setTimeout(() => (txStatus.textContent = ""), 3500);
        } catch (e) {
          console.error(e);
          const msg = e?.data?.message || e?.error?.message || e?.message || String(e);
          txStatus.textContent = "ƒ∞≈ülem hatasƒ±: " + msg;
        } finally {
          setBtnLoading(setMessageButton, false);
        }
      }

      connectButton.addEventListener("click", connectWallet);
      refreshMessageButton.addEventListener("click", readMessage);
      setMessageButton.addEventListener("click", setMessage);

      loadTxHistory();
    })();
  <script>
  (function () {
    // UI elemanƒ± (hata mesajƒ±nƒ± burada g√∂stereceƒüiz)
    const ws = document.getElementById("walletStatus");
    const log = (msg) => { if (ws) ws.textContent = String(msg || ""); };

    // Global error yakala (splash'te kalma sebeplerini g√∂r√ºn√ºr yapar)
    window.addEventListener("error", (e) => {
      log("JS error: " + (e && e.message ? e.message : "unknown"));
    });
    window.addEventListener("unhandledrejection", (e) => {
      const r = e && e.reason ? (e.reason.message || String(e.reason)) : "unknown";
      log("Promise error: " + r);
    });

    // SDK globalini kesin yakala
    // CDN UMD bazƒ± ortamlarda farklƒ± isimle gelebiliyor, hepsini deniyoruz:
    const sdk =
      (window.FarcasterMiniAppSDK && (window.FarcasterMiniAppSDK.sdk || window.FarcasterMiniAppSDK)) ||
      window.miniAppSdk ||
      window.sdk ||
      null;

    // Splash kapanmasƒ± i√ßin READY
    let readyDone = false;
    async function safeReady(tag) {
      if (readyDone) return;
      readyDone = true;
      try {
        if (!sdk || !sdk.actions || typeof sdk.actions.ready !== "function") {
          log("SDK yok / ready yok (" + tag + ")");
          return;
        }
        await sdk.actions.ready();
        log("ready ‚úÖ");
      } catch (err) {
        log("ready error: " + (err?.message || String(err)));
      }
    }

    // 1) hemen dene
    safeReady("immediate");
    // 2) 1 sn sonra tekrar dene (SDK ge√ß y√ºklenirse)
    setTimeout(() => safeReady("t+1s"), 1000);
    // 3) 2.5 sn sonra tekrar dene (failsafe)
    setTimeout(() => safeReady("t+2.5s"), 2500);

    // Ethers var mƒ± kontrol (splash deƒüil, sadece debug)
    setTimeout(() => {
      if (!window.ethers) log((ws?.textContent ? ws.textContent + " | " : "") + "ethers yok");
    }, 1500);
  })();
</script>

</body>
</html>
