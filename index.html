<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mesut - HelloBase Mini dApp</title>

  <meta name="base:app_id" content="69414c52d19763ca26ddc34d" />

  <meta
    name="fc:miniapp"
    content='{"version":"1","imageUrl":"https://base-mini-dapp.vercel.app/og.png","button":{"title":"Open Mini App","action":{"type":"launch_miniapp","name":"HelloBase Dashboard","url":"https://base-mini-dapp.vercel.app/","splashImageUrl":"https://base-mini-dapp.vercel.app/icon.png","splashBackgroundColor":"#020617"}}}'
  />
  <meta
    name="fc:frame"
    content='{"version":"1","imageUrl":"https://base-mini-dapp.vercel.app/og.png","button":{"title":"Open Mini App","action":{"type":"launch_frame","name":"HelloBase Dashboard","url":"https://base-mini-dapp.vercel.app/","splashImageUrl":"https://base-mini-dapp.vercel.app/icon.png","splashBackgroundColor":"#020617"}}}'
  />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <script type="module">
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk@0.2.1";
    window.__fcSdk = sdk;
    try { await sdk.actions.ready(); } catch {}
  </script>

  <style>
    :root{
      --bg:#020617;--bg-card:#020617;--border:#1e293b;
      --accent:#3b82f6;--text-main:#e5e7eb;--text-sub:#9ca3af;--text-muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#1d4ed8 0,#020617 40%,#000 100%);
      color:var(--text-main);
      display:flex;justify-content:center;align-items:center;
      min-height:100dvh;margin:0;padding:16px;
    }
    .shell{width:100%;max-width:960px;display:grid;grid-template-columns:minmax(0,3fr) minmax(0,2fr);gap:20px;}
    @media(max-width:768px){.shell{grid-template-columns:minmax(0,1fr);}}
    .card{
      background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:22px;
      box-shadow:0 22px 45px rgba(0,0,0,.75),0 0 0 1px rgba(15,23,42,.9);
      position:relative;overflow:hidden;
    }
    .card::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle at top left,rgba(59,130,246,.18) 0,transparent 55%);opacity:.6;pointer-events:none;}
    .card-inner{position:relative;z-index:1;}
    .header-row{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:16px;}
    .logo-pill{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(51,65,85,.8);font-size:11px;color:var(--text-sub);}
    .logo-circle{width:18px;height:18px;border-radius:999px;background:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,.25);}
    h1{font-size:20px;margin:0;color:#e0f2fe;letter-spacing:.02em;}
    .subtitle{font-size:12px;color:var(--text-sub);margin-top:4px;}
    .badge-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
    .badge{font-size:10px;border-radius:999px;padding:3px 9px;border:1px solid rgba(51,65,85,.9);color:var(--text-sub);background:rgba(15,23,42,.9);}
    button{
      background:var(--accent);border:none;border-radius:999px;color:#fff;padding:8px 16px;cursor:pointer;
      font-size:13px;font-weight:500;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;
    }
    button:disabled{background:#4b5563;cursor:not-allowed;opacity:.8;}
    .btn-secondary{background:rgba(15,23,42,.9);border:1px solid rgba(51,65,85,.9);color:var(--text-sub);}
    .section{margin-top:18px;}
    .label-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:10px;}
    .label{font-size:11px;color:var(--text-sub);text-transform:uppercase;letter-spacing:.08em;}
    .value-box{border-radius:14px;border:1px solid var(--border);padding:10px 12px;background:rgba(15,23,42,.96);font-size:12px;min-height:38px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .value-main{font-size:12px;color:var(--text-main);opacity:.9;word-break:break-all;}
    .pill{font-size:10px;border-radius:999px;padding:3px 7px;border:1px solid rgba(55,65,81,.9);color:var(--text-sub);}
    input{width:100%;padding:9px 11px;border-radius:10px;border:1px solid var(--border);background:rgba(15,23,42,.96);color:var(--text-main);font-size:13px;outline:none;}
    input::placeholder{color:#6b7280}
    .status{font-size:11px;color:var(--text-sub);margin-top:4px;min-height:16px;white-space:pre-line;}
    .hint{font-size:11px;color:var(--text-muted);margin-top:10px;}
    .tx-list{margin-top:6px;border-radius:12px;border:1px solid var(--border);background:rgba(15,23,42,.96);padding:8px 10px;max-height:180px;overflow-y:auto;}
    .tx-empty{font-size:11px;color:var(--text-muted);word-break:break-all;}
    .network-warning{
      position:fixed;top:12px;left:50%;transform:translateX(-50%);
      max-width:960px;width:calc(100% - 32px);border-radius:14px;border:1px solid rgba(248,113,113,.6);
      background:rgba(127,29,29,.95);color:#fee2e2;padding:8px 12px;font-size:12px;display:flex;gap:8px;align-items:flex-start;
      box-shadow:0 18px 40px rgba(127,29,29,.7);z-index:50;
    }
    .hidden{display:none;}
    .shimmer{
      position:relative;overflow:hidden;
      background:linear-gradient(90deg, rgba(15,23,42,.96) 0%, rgba(30,64,175,.7) 50%, rgba(15,23,42,.96) 100%);
      background-size:200% 100%;
      animation: shimmer-move 1.2s ease-in-out infinite;
    }
    @keyframes shimmer-move { 0%{background-position:-150% 0} 100%{background-position:150% 0} }
  </style>
</head>

<body>
  <div id="networkWarning" class="network-warning hidden">
    <div>‚ö†Ô∏è</div>
    <div id="networkWarningText">
      This dApp is built for <strong>Base Mainnet (chainId 8453)</strong>. Please select the correct network in your wallet.
    </div>
  </div>

  <div class="shell">
    <div class="card">
      <div class="card-inner">
        <div class="header-row">
          <div>
            <div class="logo-pill"><div class="logo-circle"></div><span>Base ‚Ä¢ Onchain Mini dApp</span></div>
            <h1>HelloBase Dashboard</h1>
            <div class="subtitle">Mesut‚Äôun Base √ºzerindeki doƒürulanmƒ±≈ü kontratƒ±yla c√ºzdanƒ±ndan direkt etkile≈üime ge√ß.</div>
            <div class="badge-row">
              <div class="badge">Deployed ‚Ä¢ 0xD6e4‚Ä¶c8F8</div>
              <div class="badge">Verified on BaseScan</div>
              <div class="badge">Built by Mesut</div>
            </div>
          </div>

          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
            <button id="connectButton" type="button"><span class="btn-label">C√ºzdanƒ± Baƒüla</span></button>
            <div id="walletStatus" style="font-family: ui-monospace, monospace; font-size:11px; color:#9ca3af; min-height:14px;"></div>
          </div>
        </div>

        <div class="section">
          <div class="label-row"><span class="label">Baƒülantƒ± durumu</span><span class="pill">EVM Wallet ‚Ä¢ Base</span></div>
          <div class="value-box"><div class="value-main" id="walletInfoText">Baƒülƒ± deƒüil</div></div>
        </div>

        <div class="section">
          <div class="label-row">
            <span class="label">Aktif mesaj (message)</span>
            <button class="btn-secondary" id="refreshMessageButton" type="button" onclick="window.__forceRefreshMessage()">Yenile</button>
          </div>
          <div class="value-box" id="currentMessageBox">
            <div class="value-main" id="currentMessage">-</div>
          </div>
        </div>

        <div class="section">
          <div class="label-row"><span class="label">Yeni mesaj yaz</span></div>
          <input id="newMessageInput" placeholder="√ñrn: Merhaba Base, Mesut buradaydƒ± ‚ú®" />
          <div class="label-row" style="margin-top: 10px;">
            <div class="status" id="txStatus"></div>
            <button id="setMessageButton" type="button" disabled><span class="btn-label">Mesajƒ± G√ºncelle</span></button>
          </div>
        </div>

        <div class="section">
          <div class="label-row"><span class="label">Son 5 i≈ülem</span><span class="pill">History</span></div>
          <div class="tx-list" id="txList"><div class="tx-empty">Hen√ºz i≈ülem yok.</div></div>
        </div>
      </div>
    </div>

   <div class="card">
  <div class="card-inner">

    <div style="font-size:13px;font-weight:500;margin-bottom:10px;">
      Mesut ‚Ä¢ Social Hub
    </div>

    <div class="profile-card">
      <div class="pfp">M√ñ</div>
      <div class="profile-meta">
        <div class="profile-name">Mesut √ñzt√ºrk</div>
        <div class="profile-sub">
          Base Builder ‚Ä¢ Farcaster Mini App<br/>
          <span style="color:#93c5fd">mesutgoktug.eth</span>
        </div>
      </div>
    </div>

    <div class="link-grid">
      <a class="link-btn" href="https://farcaster.xyz/mesutgoktug.eth" target="_blank">
        <div class="link-left">
          <div class="link-ico">üü™</div>
          <div>
            <div class="link-title">Farcaster</div>
            <div class="link-sub">mesutgoktug.eth</div>
          </div>
        </div>
        <div>‚Üó</div>
      </a>

      <a class="link-btn" href="https://x.com/soylebisey" target="_blank">
        <div class="link-left">
          <div class="link-ico">ùïè</div>
          <div>
            <div class="link-title">X (Twitter)</div>
            <div class="link-sub">@soylebisey</div>
          </div>
        </div>
        <div>‚Üó</div>
      </a>

      <a class="link-btn" href="https://talent.app/mesutgoktug.eth" target="_blank">
        <div class="link-left">
          <div class="link-ico">üèÖ</div>
          <div>
            <div class="link-title">Talent</div>
            <div class="link-sub">mesutgoktug.eth</div>
          </div>
        </div>
        <div>‚Üó</div>
      </a>

      <a class="link-btn" href="https://paragraph.com/@mesutgoktug" target="_blank">
        <div class="link-left">
          <div class="link-ico">‚úçÔ∏è</div>
          <div>
            <div class="link-title">Paragraph</div>
            <div class="link-sub">@mesutgoktug</div>
          </div>
        </div>
        <div>‚Üó</div>
      </a>

      <a class="link-btn" href="https://github.com/Mesut006" target="_blank">
        <div class="link-left">
          <div class="link-ico">üêô</div>
          <div>
            <div class="link-title">GitHub</div>
            <div class="link-sub">Mesut006</div>
          </div>
        </div>
        <div>‚Üó</div>
      </a>
    </div>

  </div>
</div>


  <script>
    (function () {
      const ethers = window.ethers;
      if (!ethers) { alert("ethers y√ºklenemedi."); return; }

      const EXPECTED_CHAIN_ID = 8453;
      const CONTRACT_ADDRESS = "0xD6e402b477B05f8105be4fAaC4a43E0355aCc8F8";
      const CONTRACT_ABI = [
        {"inputs":[],"name":"message","outputs":[{"type":"string"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"name":"newMessage","type":"string"}],"name":"setMessage","outputs":[],"stateMutability":"nonpayable","type":"function"}
      ];

      // ‚úÖ Read (yenile) her zaman Base RPC'den
      const READ_RPC = "https://base-rpc.publicnode.com";
      const readProvider = new ethers.providers.JsonRpcProvider(READ_RPC);
      const contractReadBase = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);
      window.__contractReadBase = contractReadBase;

      const connectButton = document.getElementById("connectButton");
      const walletStatus = document.getElementById("walletStatus");
      const walletInfoText = document.getElementById("walletInfoText");
      const newMessageInput = document.getElementById("newMessageInput");
      const setMessageButton = document.getElementById("setMessageButton");
      const txStatus = document.getElementById("txStatus");
      const networkWarning = document.getElementById("networkWarning");
      const networkWarningText = document.getElementById("networkWarningText");
      const txList = document.getElementById("txList");

      const currentMessageEl = document.getElementById("currentMessage");
      const currentMessageBox = document.getElementById("currentMessageBox");

      let eip1193 = null;
      let web3Provider = null;
      let address = null;
      let lastChainId = null;

      const TX_KEY = "helloBaseTxHistory";
      let txHistory = [];

      function setTopStatus(t){ walletStatus.textContent = t || ""; }
      function shortAddr(a){ return a ? (a.slice(0,6)+"‚Ä¶"+a.slice(-4)) : ""; }

      function loadTxHistory() {
        try { txHistory = JSON.parse(localStorage.getItem(TX_KEY) || "[]") || []; } catch { txHistory = []; }
        renderTxHistory();
      }
      function saveTxHistory() {
        try { localStorage.setItem(TX_KEY, JSON.stringify(txHistory)); } catch {}
      }
      function renderTxHistory() {
        if (!txHistory.length) { txList.innerHTML = '<div class="tx-empty">Hen√ºz i≈ülem yok.</div>'; return; }
        txList.innerHTML = txHistory.map(x => '<div class="tx-empty">'+x+'</div>').join("");
      }

      function updateNetworkWarning() {
        if (lastChainId !== null && lastChainId !== EXPECTED_CHAIN_ID) {
          networkWarning.classList.remove("hidden");
          networkWarningText.innerHTML =
            "This dApp is built for <strong>Base Mainnet (chainId 8453)</strong>. " +
            "Current connected chainId: <strong>" + lastChainId + "</strong>.";
        } else {
          networkWarning.classList.add("hidden");
        }
      }

      function updateActionButtons() {
        const mesajVarMi = newMessageInput.value.trim().length > 0;
        const cuzdanBagliMi = !!address;
        const baseMi = lastChainId === EXPECTED_CHAIN_ID;

        setMessageButton.disabled = !(mesajVarMi && cuzdanBagliMi && baseMi);

        if (!mesajVarMi) txStatus.textContent = "Mesaj kutusu bo≈ü";
        else if (!cuzdanBagliMi) txStatus.textContent = "C√ºzdan baƒülƒ± deƒüil";
        else if (!baseMi) txStatus.textContent = "Base aƒüƒ±na ge√ßmen gerekiyor (chainId: " + (lastChainId ?? "?") + ")";
        else txStatus.textContent = "Hazƒ±r ‚úÖ";
      }

      async function getProvider() {
        const sdk = window.__fcSdk;
        try {
          const isMini = await (sdk?.isInMiniApp?.().catch(() => false));
          if (isMini) {
            const p = await sdk.wallet.getEthereumProvider();
            if (p?.request) return p;
          }
        } catch {}
        if (window.ethereum?.request) return window.ethereum;
        return null;
      }

      async function refreshState() {
        if (!web3Provider) { updateActionButtons(); return; }

        const accounts = await web3Provider.listAccounts();
        address = accounts?.[0] || null;

        const net = await web3Provider.getNetwork();
        lastChainId = net.chainId;

        walletInfoText.textContent = address
          ? ("Aƒü chainId: " + lastChainId + " | C√ºzdan: " + shortAddr(address))
          : "Baƒülƒ± deƒüil";

        updateNetworkWarning();
        updateActionButtons();
      }

      async function connectWallet() {
        setTopStatus("Baƒülanƒ±lƒ±yor...");
        try {
          eip1193 = await getProvider();
          if (!eip1193) { setTopStatus("Provider yok"); return; }

          await eip1193.request({ method: "eth_requestAccounts", params: [] });
          web3Provider = new ethers.providers.Web3Provider(eip1193, "any");

          setTopStatus("Hazƒ±r ‚úÖ");
          await refreshState();
        } catch (e) {
          setTopStatus("Baƒülantƒ± hatasƒ±: " + (e?.message || String(e)));
        }
      }

      async function setMessage() {
        if (!address) { txStatus.textContent = "C√ºzdan baƒülƒ± deƒüil"; return; }
        if (lastChainId !== EXPECTED_CHAIN_ID) { txStatus.textContent = "Base aƒüƒ±na ge√ß"; return; }

        const text = newMessageInput.value.trim();
        if (!text) { txStatus.textContent = "Mesaj bo≈ü"; return; }

        txStatus.textContent = "Onay bekleniyor...";
        try {
          const iface = new ethers.utils.Interface(CONTRACT_ABI);
          const data = iface.encodeFunctionData("setMessage", [text]);

          const txHash = await eip1193.request({
            method: "eth_sendTransaction",
            params: [{
              from: address,
              to: CONTRACT_ADDRESS,
              data,
              value: "0x0"
            }]
          });

          txHistory.unshift(String(txHash || ("tx-" + Date.now())));
          txHistory = txHistory.slice(0,5);
          saveTxHistory();
          renderTxHistory();

          txStatus.textContent = "ƒ∞≈ülem g√∂nderildi ‚úÖ (onay bekleniyor...)";
          newMessageInput.value = "";
          updateActionButtons();

          try { await readProvider.waitForTransaction(txHash, 1, 60000); } catch {}
          await window.__forceRefreshMessage();
        } catch (e) {
          txStatus.textContent = "ƒ∞≈ülem hatasƒ±: " + (e?.message || String(e));
        }
      }

      // ‚úÖ window √ºst√ºnden g√ºvenli yenile
      window.__forceRefreshMessage = async function () {
        try {
          const el = document.getElementById("currentMessage");
          const box = document.getElementById("currentMessageBox");
          const status = document.getElementById("txStatus");

          if (!el) { if (status) status.textContent = "Hata: #currentMessage yok"; return; }

          if (status) status.textContent = "Yenileniyor...";
          if (box) box.classList.add("shimmer");

          const msg = await window.__contractReadBase.message();
          el.textContent = msg || "(Bo≈ü)";

          if (status) status.textContent = "G√ºncellendi ‚úÖ";
        } catch (e) {
          const status = document.getElementById("txStatus");
          if (status) status.textContent = "Yenileme hatasƒ±: " + (e?.message || String(e));
        } finally {
          const box = document.getElementById("currentMessageBox");
          if (box) box.classList.remove("shimmer");
        }
      };

      connectButton.addEventListener("click", connectWallet);
      setMessageButton.addEventListener("click", setMessage);
      newMessageInput.addEventListener("input", updateActionButtons);

      loadTxHistory();
      updateActionButtons();
      window.__forceRefreshMessage().catch(()=>{});
    })();
  </script>
</body>
</html>
